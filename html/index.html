<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bareflank APIs (version 1.1.0)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Bareflank APIs (version 1.1.0) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="pageTOC"></a>
Content</h1>
<ol type="1">
<li><a class="el" href="index.html#description">Description</a></li>
<li><a class="el" href="index.html#license">License</a></li>
<li><a class="el" href="index.html#unit_tests">Unit Tests</a></li>
<li><a class="el" href="index.html#extending_bareflank">Extending Bareflank</a></li>
<li><a class="el" href="/home/user/hypervisor/include/mainpage.h.html#vmm_reference">VMM Reference</a></li>
<li><a class="el" href="/home/user/hypervisor/include/mainpage.h.html#serial">Serial Setup</a></li>
</ol>
<h1><a class="anchor" id="description"></a>
Description</h1>
<p>The Bareflank Hypervisor is an open source, lightweight hypervisor, lead by Assured Information Security, Inc. that provides the scaffolding needed to rapidly prototype new hypervisors. To ease development, Bareflank is written in C++, and includes support for exceptions and the C++ Standard Template Library (STL) via libc++. With the C++ STL, users can leverage shared pointers, complex data structures (e.g. hash tables, maps, lists, etc…), and several other modern C++ features. Existing open source hypervisors that are written in C are difficult to modify, and spend a considerable amount of time re-writing similar functionality instead of focusing on what matters most: hypervisor technologies. Furthermore, users can leverage inheritance to extend every part of the hypervisor to provide additional functionality above and beyond what is already provided.</p>
<p>To this end, Bareflank's primary goal is to remain simple, and minimalistic, providing only the scaffolding needed to construct more complete/complicated hypervisors including:</p><ul>
<li>Type 1 Hypervisors (like Xen)</li>
<li>Type 2 Hypervisors (like VirtualBox)</li>
<li>Host-Only Hypervisors (commonly used by anti-virus and rootkits)</li>
</ul>
<p>The core business logic will remain in the hypervisors that extend Bareflank, and not in Bareflank itself.</p>
<h1><a class="anchor" id="license"></a>
License</h1>
<p>To support Bareflank's design approach, the entire project is licensed under the GNU Lesser General Public License v2.1 (LGPL), specifically enabling users of the project to both contribute back to the project, but also create proprietary extensions if so desired. For more information please see:</p>
<p><a href="http://www.gnu.org/licenses/old-licenses/lgpl-2.1.en.html">GNU Lesser General Public License, version 2.1</a></p>
<h1><a class="anchor" id="unit_tests"></a>
Unit Tests</h1>
<p>In addition to Bareflank’s lightweight, modular design, the entire hypervisor has been written using test driven development. As such, all of Bareflank’s code comes complete with a set of unit tests to validate that the provided code works as expected.</p>
<p>To execute the unit tests, run: </p><div class="fragment"><div class="line">make test</div></div><!-- fragment --><p>Bareflank uses Hippomocks for mocking C/C++ functionality in the unit tests when needed. As such, Bareflank includes a version of Hippomocks that can be used by Bareflank extensions. For more information on how to use Hippomocks, checkout some of the existing unit tests in the bfvmm, as well as the following:</p>
<p><a href="http://hippomocks.com/Main_Page">Hippomocks</a></p>
<h1><a class="anchor" id="extending_bareflank"></a>
Extending Bareflank</h1>
<p>Bareflank's VMM is written as a set of ELF modules. Extending the VMM is as simple as adding / replacing the existing modules with new functionality. For example, suppose you want to prototype a new memory management algorithm for your hypervisor. Doing so is as simple as replacing the <a class="el" href="classmemory__manager__x64.html">memory_manager_x64</a> module with your own.</p>
<p>In most cases, your likely to be more interested in modifying the virtualization extension logic. Currently Bareflank supports Intel, but ARM and AMD are planned for future releases. The VMM is broken up into the following major components:</p>
<ul>
<li>Support Logic (memory manager, serial, libc++, etc...)</li>
<li>Virtual CPU Management</li>
<li>Virtualization Extension Logic</li>
</ul>
<p>The support logic enables the VMM environment. For example, libc++ provides std::cout for debugging which uses the <a class="el" href="classmemory__manager__x64.html">memory_manager_x64</a> to allocate memory, and the <a class="el" href="classserial__port__intel__x64.html">serial_port_intel_x64</a> / <a class="el" href="classdebug__ring.html">debug_ring</a> to output the resulting text to. The virtualization extension logic is responsible for setting up, and enabling virtualization. This logic is specific to the architecture your using. On Intel, this consists of the VMXON, VMCS, exit handler, and intrinsics logic.</p>
<p>To encapsulate the architectural specific logic, each architecture has its own vCPU (for Intel this is <a class="el" href="classvcpu__intel__x64.html">vcpu_intel_x64</a>) that subclasses a generic vCPU (<a class="el" href="classvcpu.html">vcpu</a>) used by the <a class="el" href="classvcpu__manager.html">vcpu_manager</a>, and created by the <a class="el" href="classvcpu__factory.html">vcpu_factory</a>. The <a class="el" href="classvcpu__factory.html">vcpu_factory</a> is in its own module, specifically so that users of Bareflank can replace this module with their own factory.</p>
<p>The process of extending Bareflank with custom virtualization logic, starts by subclassing the code you wish to extend. In this example we will extend the <a class="el" href="classexit__handler__intel__x64.html">exit_handler_intel_x64</a> to count the number of CPUIDs that have been executed, but you can subclass anything including the <a class="el" href="classvmxon__intel__x64.html">vmxon_intel_x64</a>, <a class="el" href="classvmcs__intel__x64.html">vmcs_intel_x64</a>, intrinsics_intel_x64 logic, etc... Worst case, you can always outright provide your own modules for this same logic. Subclassing the code that Bareflank already provides, allows you to leverage the existing scaffolding that Bareflank has, likely saving you some additional time.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>exit_handler_cpuidcount : <span class="keyword">public</span> <a class="code" href="classexit__handler__intel__x64.html">exit_handler_intel_x64</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line"></div><div class="line">    exit_handler_cpuidcount() :</div><div class="line">        m_count(0)</div><div class="line">    { }</div><div class="line"></div><div class="line">    ~exit_handler_cpuidcount()<span class="keyword"> override</span></div><div class="line"><span class="keyword">    </span>{ bfdebug &lt;&lt; <span class="stringliteral">&quot;cpuid count = &quot;</span> &lt;&lt; m_count &lt;&lt; bfendl; }</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="classexit__handler__intel__x64.html#a2841b513de1f9471b8f1b54f63dd0272">handle_exit</a>(<a class="code" href="namespaceintel__x64_1_1vmcs.html#a3d6b2ecb9978874c95387bda890c0c91">intel_x64::vmcs::value_type</a> reason)<span class="keyword"> override</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">        <span class="keywordflow">if</span> (reason == <a class="code" href="namespaceintel__x64_1_1vmcs_1_1exit__reason_1_1basic__exit__reason.html#abb19dafcfd89369118405a227d9970cc">vmcs::exit_reason::basic_exit_reason::cpuid</a>)</div><div class="line">            m_count++;</div><div class="line"></div><div class="line">        <a class="code" href="classexit__handler__intel__x64.html#a2841b513de1f9471b8f1b54f63dd0272">exit_handler_intel_x64::handle_exit</a>(reason);</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line"></div><div class="line">    int64_t m_count;</div><div class="line">};</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 28 2017 18:26:26 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
