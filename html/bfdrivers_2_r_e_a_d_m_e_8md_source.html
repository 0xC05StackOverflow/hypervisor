<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>/home/user/hypervisor/bfdrivers/README.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/user/hypervisor/bfdrivers/README.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="bfdrivers_2_r_e_a_d_m_e_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# Bareflank Drivers {#bfdrivers_readme}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;## Description</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;The Bareflank drivers (also referred to as the driver entries), are the drivers that load, start, stop, and unload the VMM. The only reason the driver entries are needed is because hypervisor code requires ring 0 to execute (one reason why Apple has created a userspace API for managing hypervisors in ring 3 in OS X). Thus, the driver entries are designed specifically to be as small as possible, with the only code being the IOCTL interface that BFM uses to communicate with the driver entry, as well as the ELF loader used to load and execute the VMM.</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;## How It is Used</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;A Bareflank driver consists of the host OS specific part, and the common.c part. On Linux, this is:</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;[Linux entry.c](https://github.com/Bareflank/hypervisor/blob/master/bfdrivers/src/arch/linux/entry.c)</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;&lt;br&gt;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;[Common](https://github.com/Bareflank/hypervisor/blob/master/bfdrivers/src/common.c)</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;The host OS part could be from a host OS like Windows or Linux, but also could be a boot environment like UEFI (or BIOS/GRUB if you so inclined to provide legacy support). The common.c part is the bulk of the driver entry, and this code is shared between all of the driver entries, and comes complete with it&#39;s own unit test.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;When BFM IOCTL&#39;s to the driver entry, the host OS part receives the IOCTL, and calls the associated common_xxx logic. Anything that must be done that is host OS specific must be done in the host OS part. For example, currently, Bareflank uses the CR3 page tables setup by BFM when it executes. These page tables are destroyed when BFM finishes it&#39;s execution, but are still being used by the VMM (a limitation that will be addressed in version 1.1). To prevent the page tables from being destroyed, the Linux entry.c saves the BFM context, which must be done outside of the common source code.</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;[save context](https://github.com/Bareflank/hypervisor/blob/master/bfdrivers/src/arch/linux/entry.c#L200)</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;To support the unit test for the common.c part, a set of dummy VMM modules were created, each of which provide dummy symbols for required VMM functionality, providing a means to test different combinations for issues that can occur. For example, one test combination loads a set of dummy modules, specifically leaving out a module that has a required symbol, causing the common.c code to enter an error state, and prove that it can handle the error.</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;## Limitations</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;At the moment, the single biggest limitation with the driver entries is the lack of being able to extend them with custom functionality. Since the driver entry is really just a BFM to VMM communication mechanism, our goal is to provide a driver entry that has support for custom messages to the VMM (likely via a hypercall interface to start, but will likely provide more than that in the future).</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;The driver entries currently do no support multi-core (being addressed in version 1.1), and the driver entries have to save the user space page tables as the VMM does not create it&#39;s own (also being addressed in version 1.1).</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;## Notes</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;One issue that you will notice while developing in Bareflank is that a bug in the VMM does not translate well to kernel debuggers. This is because we are manually bootstrapping the VMM&#39;s environment inside the kernel, so the kernel has no clue what the VMM code is, or how to handle it when an error occurs. This is why developing with serial, or some other external debugging mechanism (like a PCI debugger) is critical. In some cases, if you do get a valid address as the cause of the error, you can sometimes use that information to figure out where in the code VMM code the crash happened.</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Apr 20 2016 15:38:37 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
